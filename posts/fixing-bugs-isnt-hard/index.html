<!doctype html><html lang=en><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<style>:root{--accent-color:#00dd42}</style>
<title>Fixing Bugs Isn't Hard!</title>
<meta name=description content="Hello! I’m Anthony Wang, a programming, math, and science enthusiast!">
<meta name=keywords content="Linux,KDE">
<meta property="og:url" content="https://ta180m.github.io/posts/fixing-bugs-isnt-hard/">
<meta property="og:type" content="website">
<meta property="og:title" content="Fixing Bugs Isn't Hard!">
<meta property="og:description" content="Hello! I’m Anthony Wang, a programming, math, and science enthusiast!">
<meta property="og:image" content="/dodecahedra/render-cropped.webp">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:title content="Fixing Bugs Isn't Hard!">
<meta name=twitter:description content="Hello! I’m Anthony Wang, a programming, math, and science enthusiast!">
<meta property="twitter:domain" content="https://ta180m.github.io/posts/fixing-bugs-isnt-hard/">
<meta property="twitter:url" content="https://ta180m.github.io/posts/fixing-bugs-isnt-hard/">
<meta name=twitter:image content="/dodecahedra/render-cropped.webp">
<link rel=canonical href=https://ta180m.github.io/posts/fixing-bugs-isnt-hard/>
<link rel=stylesheet type=text/css href=/css/normalize.min.css media=print onload="this.media='all'">
<link rel=stylesheet type=text/css href=/css/main.css>
<link disabled id=dark-theme rel=stylesheet href=/css/dark.css>
<script src=/js/svg-injector.min.js></script>
<script src=/js/feather-icons.min.js></script>
<script src=/js/main.js></script>
</head>
<body>
<script type=text/javascript>setThemeByUserPref()</script><header class=header>
<nav class=header-nav>
<div class=avatar>
<a href=https://ta180m.github.io/>
<img src=/dodecahedra/render-cropped.webp alt=avatar>
</a>
</div>
<div class=nav-title>
<a class=nav-brand href=https://ta180m.github.io/>Some Random Website</a>
</div>
<div class=nav-links>
<div class=nav-link>
<a href=/about/><span data-feather=aperture></span> About </a>
</div>
<div class=nav-link>
<a href=/projects/><span data-feather=package></span> Projects </a>
</div>
<div class=nav-link>
<a href=/posts/><span data-feather=book></span> Posts </a>
</div>
<div class=nav-link>
<a href=/tags/><span data-feather=tag></span> Tags </a>
</div>
<div class=nav-link>
<a href=/index.xml><span data-feather=rss></span> Feed </a>
</div>
<div class=nav-link>
<a href=https://git.exozy.me/Ta180m/website><span data-feather=git-pull-request></span> Git </a>
</div>
<span class=nav-icons-divider></span>
<div class="nav-link dark-theme-toggle">
<a>
<span id=theme-toggle-icon data-feather=moon></span>
</a>
</div>
<div class=nav-link id=hamburger-menu-toggle>
<a>
<span data-feather=menu></span>
</a>
</div>
<ul class="nav-hamburger-list visibility-hidden">
<li class=nav-item>
<a href=/about/><span data-feather=aperture></span> About </a>
</li>
<li class=nav-item>
<a href=/projects/><span data-feather=package></span> Projects </a>
</li>
<li class=nav-item>
<a href=/posts/><span data-feather=book></span> Posts </a>
</li>
<li class=nav-item>
<a href=/tags/><span data-feather=tag></span> Tags </a>
</li>
<li class=nav-item>
<a href=/index.xml><span data-feather=rss></span> Feed </a>
</li>
<li class=nav-item>
<a href=https://git.exozy.me/Ta180m/website><span data-feather=git-pull-request></span> Git </a>
</li>
<li class="nav-item dark-theme-toggle">
<a>
<span id=theme-toggle-icon data-feather=moon></span>
</a>
</li>
</ul>
</div>
</nav>
</header>
<main id=content>
<div class="post container">
<div class=post-header-section>
<h1>Fixing Bugs Isn't Hard!</h1>
<small role=doc-subtitle></small>
<p class=post-date>
April 13, 2021
</p>
<ul class=post-tags>
<li class=post-tag><a href=/tags/linux>Linux</a></li>
<li class=post-tag><a href=/tags/kde>KDE</a></li>
</ul>
</div>
<div class=post-content>
<p>
<p><em>Originally posted on my <a href=https://git.exozy.me/Ta180m/blog/src/branch/main/_posts/2021-04-13-fixing-bugs-isnt-hard.md>old blog</a></em></p>
<p>A few days ago, I wanted to record my screen, and in process, I discovered <a href="https://bugs.kde.org/show_bug.cgi?id=417575">this bug</a>. It doesn&rsquo;t seem like a very complicated bug, right? Just look through the code, find out what&rsquo;s wrong, and send in a pull request! Or is it that easy?</p>
<p><img src=/images/spectacle.png alt="The bug"></p>
<p>The first issue is that <a href=https://invent.kde.org/graphics/spectacle>Spectacle&rsquo;s code</a> is not exactly the most readable code out there, but I was able to identify [line 209 in <code>GUI/KSMainWindow.cpp</code>] as the critical line. So what is <code>mScreenrecorderToolsMenuFactory</code> and what does <code>fillMenuFromGroupingNames</code> do?</p>
<p>They are actually functions in <a href=https://invent.kde.org/frameworks/knewstuff>KNewStuff</a>, which I saw was referenced on the bug report. So, I <code>git</code> cloned the repository and started to get my hands wet.</p>
<p>The first thing to do was to read through the code, except like Spectacle, it wasn&rsquo;t easy. To make things worse, the function calls snaked through various files, going from <code>kmoretools/kmoretoolsmenufactory.cpp</code> to <code>kmoretools/kmoretoolspresets.cpp</code> to ``kmoretools/kmoretools.cpp`. But as I went deeper, it got more and more confusing.</p>
<p>Time to pull out the power tools! <code>gdb</code> time! Arch doesn&rsquo;t have KDE debug symbols in any repository, so I compiled Spectacle and KNewStuff myself and installed them. Now I&rsquo;m just a <code>gdb</code> away from finding the bug!</p>
<p>Or not. Turns out that when <code>gdb</code> hits a breakpoint, the entire X server freezes. Yeah, that&rsquo;s no too good. I first tried debugging it in a TTY but later realized it would be much easier to spin up a Xephyr nested server and run it on there.</p>
<p>That aside, it was now time to find the bug! I added breakpoints strategically such as on the critical line 209 in <code>GUI/KSMainWindow.cpp</code>. After following the code down several levels, I finally reached&mldr;</p>
<p><a href=https://invent.kde.org/frameworks/knewstuff/blob/a90a326fb570315e13dc3f24e80e8a032b960647/src/kmoretools/kmoretools.cpp#L122>KService</a>. What the heck is <a href=https://invent.kde.org/frameworks/kservice/>KService</a>? Do I really have to clone and compile yet another repository?</p>
<p>The last piece of the puzzle was actually printing out the QStrings, since QT apps just <em>have</em> to use their own string class instead of the one in the standard library. Fortunately, KDE has some nice <a href=https://invent.kde.org/sdk/kde-dev-scripts/-/blob/master/kde-devel-gdb>GDB scripts</a> to dump in the <code>.gdbinit</code>, and after doing that, I could print QStrings without a problem.</p>
<p>Finally, after digging through more code, I reached the bottom of this!</p>
<pre tabindex=0><code>Thread 1 &quot;spectacle&quot; hit Breakpoint 2, KServiceFactory::findServiceByDesktopName (
    this=0x555555ca04b0, _name=...)
    at /home/ta180m/git/kservice/src/services/kservicefactory.cpp:91
91          if (!m_nameDict) {
(gdb) printq5string _name
com.obsproject.Studio
(gdb) n
[Thread 0x7fffaf7fe640 (LWP 133529) exited]
[Thread 0x7fffae7fc640 (LWP 133531) exited]
[Thread 0x7fffaeffd640 (LWP 133530) exited]
[Thread 0x7fffadffb640 (LWP 133532) exited]
98          int offset = m_nameDict-&gt;find_string(_name);
(gdb) n
99          if (!offset) {
(gdb) p offset
$1 = 385190
(gdb) n
103         KService::Ptr newService(createEntry(offset));
(gdb) n
106         if (newService &amp;&amp; (newService-&gt;desktopEntryName() != _name)) {
(gdb) p newService-&gt;desktopEntryName()
$2 = {d = 0x555555d232c0}
(gdb) printq5string newService-&gt;desktopEntryName()
com.obsproject.studio
</code></pre><p>Note that the top <code>com.obsproject.Studio</code> has different capitalization than <code>com.obsproject.studio</code>! This, as it so happens, is the true cause of the bug. <code>vokoscreenNG</code> also has two capital letters, which probably cause the same thing to happen. Perfect, we&rsquo;ve found the bug!</p>
<p>Great, so how do we fix it now? None of the KDE codebases are properly designed to be able to handle uppercase names like these, so this is bound to cause more problems in the future. One easy fix could be to convert the names to lowercase before calling the KService functions, but who knows how many bugs are currently plaguing KService because of this? I don&rsquo;t really want to meddle with KService so I think I&rsquo;ll create a pull request for KNewStuff.</p>
<p><img src=/images/spectacle-patched.png alt=Fixed!></p>
<p>Time to send in a <a href=https://invent.kde.org/frameworks/knewstuff/-/merge_requests/115>pull request</a> (or merge request as they call it on GitLab)! The actual patch is tiny: just add a <code>.toLower()</code> on line 122 of <code>kmoretools/kmoretools.cpp</code>. So little for so much hard work!</p>
<p>Well, it&rsquo;s great that this small bug has finally been solved. Debugging isn&rsquo;t hard! You just need to be persistent, and you&rsquo;ll get to the root cause of the bug eventually. Well, maybe I got lucky here, but it&rsquo;s not hard to be a bug fixer! I&rsquo;m just waiting for the patch to get merged. Until next time!</p>
</p>
</div>
</div>
</main><footer class=footer>
<span>Made with ❤️ by Ta180m - CC BY-SA 4.0</span>
</footer>
</body>
</html>