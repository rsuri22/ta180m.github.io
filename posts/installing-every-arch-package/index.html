<!doctype html><html lang=en><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<style>:root{--accent-color:#00dd42}</style>
<title>Installing Every Arch Package</title>
<meta name=description content="Using algorithms and Julia to install as many packages as possible from the Arch Linux official repositories">
<meta name=keywords content="linux,fun,algorithms,computer-science">
<meta property="og:url" content="https://ta180m.github.io/posts/installing-every-arch-package/">
<meta property="og:type" content="website">
<meta property="og:title" content="Installing Every Arch Package">
<meta property="og:description" content="Using algorithms and Julia to install as many packages as possible from the Arch Linux official repositories">
<meta property="og:image" content="/dodecahedra/render-small.gif">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:title content="Installing Every Arch Package">
<meta name=twitter:description content="Using algorithms and Julia to install as many packages as possible from the Arch Linux official repositories">
<meta property="twitter:domain" content="https://ta180m.github.io/posts/installing-every-arch-package/">
<meta property="twitter:url" content="https://ta180m.github.io/posts/installing-every-arch-package/">
<meta name=twitter:image content="/dodecahedra/render-small.gif">
<link rel=canonical href=https://ta180m.github.io/posts/installing-every-arch-package/>
<link rel=stylesheet type=text/css href=/css/normalize.min.css media=print onload="this.media='all'">
<link rel=stylesheet type=text/css href=/css/main.css>
<link disabled id=dark-theme rel=stylesheet href=/css/dark.css>
<script src=/js/svg-injector.min.js></script>
<script src=/js/feather-icons.min.js></script>
<script src=/js/main.js></script>
</head>
<body>
<script type=text/javascript>setThemeByUserPref()</script><header class=header>
<nav class=header-nav>
<div class=avatar>
<a href=https://ta180m.github.io/>
<img src=/dodecahedra/render-small.gif alt=avatar>
</a>
</div>
<div class=nav-title>
<a class=nav-brand href=https://ta180m.github.io/>Some Random Website</a>
</div>
<div class=nav-links>
<div class=nav-link>
<a href=/about/><span data-feather=aperture></span> About </a>
</div>
<div class=nav-link>
<a href=/projects/><span data-feather=package></span> Projects </a>
</div>
<div class=nav-link>
<a href=/posts/><span data-feather=book></span> Posts </a>
</div>
<div class=nav-link>
<a href=/tags/><span data-feather=tag></span> Tags </a>
</div>
<div class=nav-link>
<a href=/index.xml><span data-feather=rss></span> Feed </a>
</div>
<div class=nav-link>
<a href=https://git.exozy.me/Ta180m/website><span data-feather=git-pull-request></span> Git </a>
</div>
<span class=nav-icons-divider></span>
<div class="nav-link dark-theme-toggle">
<a>
<span id=theme-toggle-icon data-feather=moon></span>
</a>
</div>
<div class=nav-link id=hamburger-menu-toggle>
<a>
<span data-feather=menu></span>
</a>
</div>
<ul class="nav-hamburger-list visibility-hidden">
<li class=nav-item>
<a href=/about/><span data-feather=aperture></span> About </a>
</li>
<li class=nav-item>
<a href=/projects/><span data-feather=package></span> Projects </a>
</li>
<li class=nav-item>
<a href=/posts/><span data-feather=book></span> Posts </a>
</li>
<li class=nav-item>
<a href=/tags/><span data-feather=tag></span> Tags </a>
</li>
<li class=nav-item>
<a href=/index.xml><span data-feather=rss></span> Feed </a>
</li>
<li class=nav-item>
<a href=https://git.exozy.me/Ta180m/website><span data-feather=git-pull-request></span> Git </a>
</li>
<li class="nav-item dark-theme-toggle">
<a>
<span id=theme-toggle-icon data-feather=moon></span>
</a>
</li>
</ul>
</div>
</nav>
</header>
<main id=content>
<div class="post container">
<div class=post-header-section>
<h1>Installing Every Arch Package</h1>
<small role=doc-subtitle>Using algorithms and Julia to install as many packages as possible from the Arch Linux official repositories</small>
<p class=post-date>
January 26, 2022
</p>
<ul class=post-tags>
<li class=post-tag><a href=/tags/linux>linux</a></li>
<li class=post-tag><a href=/tags/fun>fun</a></li>
<li class=post-tag><a href=/tags/algorithms>algorithms</a></li>
<li class=post-tag><a href=/tags/computer-science>computer-science</a></li>
</ul>
</div>
<div class=post-content>
<p>
<p><img src=/images/install-every-arch-package-matrix.png alt="A stupid idea on Matrix"></p>
<p>Challenge accepted. Let&rsquo;s do it!</p>
<p>First things first, let&rsquo;s generate a list of <a href=https://archlinux.org/packages/>all official Arch Linux packages</a>. Fortunately, <code>pacman</code>, the best pragmatic package manager in existence, makes this a breeze.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>pacman -Sql
</code></pre></div><p>Great, now let&rsquo;s install it all!</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo pacman -S <span style=color:#66d9ef>$(</span>pacman -Sql<span style=color:#66d9ef>)</span>
</code></pre></div><p>10 seconds later, you&rsquo;ll find yourself with&mldr; unresolvable package conflicts detected?</p>
<p>OK, fine, let&rsquo;s disable dependency checking then:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo pacman -Sdd <span style=color:#66d9ef>$(</span>pacman -Sql<span style=color:#66d9ef>)</span>
</code></pre></div><p>Nope, didn&rsquo;t work. We have to do something about the conflicting packages!</p>
<p>We could resolve all the conflicts manually with an hour of work&mldr; or we could write a program!</p>
<p><img src=https://imgs.xkcd.com/comics/automation.png alt=Automation></p>
<h2 id=time-for-some-algorithms>Time for some algorithms!</h2>
<p>It&rsquo;s time to put our algorithms knowledge to good use. This is <em>just</em> a graph We can think of each package as a node in a graph and each conflict is an edge. Since we don&rsquo;t care about dependency checks (which would make for a likely broken system), we don&rsquo;t need to add any other edges to the graph.</p>
<p>For each edge, we need to pick at most one package, but not both. That sounds a lot like a <a href=https://en.wikipedia.org/wiki/Maximum_independent_set>maximum independent set</a>!</p>
<p>Wait&mldr; it&rsquo;s NP hard though? And we have up to 12000 nodes, so we&rsquo;ll never be able to find the answer before the heat death of the universe, right?</p>
<p>Well, do we have 12000 <em>connected</em> nodes? No, since the largest connected component is probably only a few nodes. We aren&rsquo;t going to have hundreds or thousands of packages all conflicting with each other. Therefore, we don&rsquo;t need to solve <a href=https://en.wikipedia.org/wiki/P_versus_NP_problem>P vs. NP</a> to be able to find the maximum independent set of this particular graph. Phew!</p>
<h2 id=implementing-this-in-julia>Implementing this in Julia</h2>
<p>We&rsquo;re going to use <a href=https://julialang.org/>Julia</a> for implementing this algorithm, since Julia is Python but better. We first need to get a list of all packages:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jl data-lang=jl>pkgname <span style=color:#f92672>=</span> split(read(<span style=color:#e6db74>`pacman -Sql`</span>, <span style=color:#66d9ef>String</span>))

N <span style=color:#f92672>=</span> length(pkgname)
</code></pre></div><p>Now, we&rsquo;ll get info about each package, using multithreading to speed things up:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jl data-lang=jl><span style=color:#66d9ef>struct</span> <span style=color:#66d9ef>Package</span>
    provides<span style=color:#f92672>::</span><span style=color:#66d9ef>Vector</span>{<span style=color:#66d9ef>String</span>}
    conflicts<span style=color:#f92672>::</span><span style=color:#66d9ef>Vector</span>{<span style=color:#66d9ef>String</span>}
    size<span style=color:#f92672>::</span><span style=color:#66d9ef>Float64</span>
<span style=color:#66d9ef>end</span>

pkginfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>Vector</span>{<span style=color:#66d9ef>Package</span>}(undef, N)

Threads<span style=color:#f92672>.</span><span style=color:#a6e22e>@threads</span> <span style=color:#66d9ef>for</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>N
    pkg <span style=color:#f92672>=</span> pkgname[i]
    info <span style=color:#f92672>=</span> map(x <span style=color:#f92672>-&gt;</span> split(replace(split(x, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)[<span style=color:#ae81ff>1</span>], <span style=color:#e6db74>&#34;None&#34;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;&#34;</span>)), split(read(<span style=color:#e6db74>`pacman -Si </span><span style=color:#e6db74>$pkg</span><span style=color:#e6db74>`</span>, <span style=color:#66d9ef>String</span>), <span style=color:#e6db74>&#34; : &#34;</span>))
    push!(info[<span style=color:#ae81ff>10</span>], pkg)
    pkginfo[i] <span style=color:#f92672>=</span> Package(info[<span style=color:#ae81ff>10</span>], info[<span style=color:#ae81ff>13</span>], parse(<span style=color:#66d9ef>Float64</span>, info[<span style=color:#ae81ff>16</span>][<span style=color:#ae81ff>1</span>]))
<span style=color:#66d9ef>end</span>
</code></pre></div><p>We need special handling for <a href=https://wiki.archlinux.org/title/Pacman#Virtual_packages>virtual packages</a>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jl data-lang=jl>providedby <span style=color:#f92672>=</span> <span style=color:#66d9ef>Dict</span>{<span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>Vector</span>{<span style=color:#66d9ef>Int</span>}}()

<span style=color:#66d9ef>for</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>N
	<span style=color:#66d9ef>for</span> p <span style=color:#66d9ef>in</span> pkginfo[i]<span style=color:#f92672>.</span>provides
		p <span style=color:#f92672>=</span> split(p, <span style=color:#e6db74>&#34;=&#34;</span>)[<span style=color:#ae81ff>1</span>]
		<span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span>(p <span style=color:#66d9ef>in</span> keys(providedby))
			providedby[p] <span style=color:#f92672>=</span> <span style=color:#66d9ef>Vector</span>{<span style=color:#66d9ef>Int</span>}()
		<span style=color:#66d9ef>end</span>
		push!(providedby[p], i)
	<span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>We can use this to construct the graph:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jl data-lang=jl>G <span style=color:#f92672>=</span> [<span style=color:#66d9ef>Set</span>{<span style=color:#66d9ef>Int</span>}() <span style=color:#66d9ef>for</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>N]

<span style=color:#66d9ef>for</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>N
	<span style=color:#66d9ef>for</span> p <span style=color:#66d9ef>in</span> pkginfo[i]<span style=color:#f92672>.</span>conflicts
		<span style=color:#66d9ef>if</span> p <span style=color:#66d9ef>in</span> keys(providedby)
			<span style=color:#66d9ef>for</span> j <span style=color:#66d9ef>in</span> providedby[p]
				<span style=color:#66d9ef>if</span> j <span style=color:#f92672>!=</span> i
					push!(G[i], j)
					push!(G[j], i)
				<span style=color:#66d9ef>end</span>
			<span style=color:#66d9ef>end</span>
		<span style=color:#66d9ef>end</span>
	<span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>Now we can find each connected component using <a href=https://en.wikipedia.org/wiki/Breadth-first_search>BFS</a>, and brute-force the maximum independent set by trying every subset of the nodes in that component. It&rsquo;s implemented here using some bit manipulation trickery.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jl data-lang=jl>ans <span style=color:#f92672>=</span> <span style=color:#66d9ef>BitSet</span>(<span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>N)

used <span style=color:#f92672>=</span> <span style=color:#66d9ef>BitSet</span>()

<span style=color:#66d9ef>for</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>N
	<span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span>(i <span style=color:#66d9ef>in</span> used)
		push!(used, i)
		component <span style=color:#f92672>=</span> <span style=color:#66d9ef>Vector</span>{<span style=color:#66d9ef>Int</span>}()
		queue <span style=color:#f92672>=</span> <span style=color:#66d9ef>Vector</span>{<span style=color:#66d9ef>Int</span>}([i])
		<span style=color:#66d9ef>while</span> <span style=color:#f92672>!</span>isempty(queue)
			u <span style=color:#f92672>=</span> popfirst!(queue)
			push!(component, u)
			<span style=color:#66d9ef>for</span> v <span style=color:#66d9ef>in</span> G[u]
				<span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span>(v <span style=color:#66d9ef>in</span> used)
					push!(used, v)
					push!(queue, v)
				<span style=color:#66d9ef>end</span>
			<span style=color:#66d9ef>end</span>
		<span style=color:#66d9ef>end</span>

		M <span style=color:#f92672>=</span> length(component)
		best <span style=color:#f92672>=</span> (<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0.0</span>, <span style=color:#ae81ff>0</span>)
		<span style=color:#66d9ef>for</span> m <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>(<span style=color:#ae81ff>1</span><span style=color:#f92672>&lt;&lt;</span>M)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
			good <span style=color:#f92672>=</span> true
			<span style=color:#66d9ef>for</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>M
				<span style=color:#66d9ef>if</span> (m<span style=color:#f92672>&gt;&gt;</span>(j<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>))<span style=color:#f92672>&amp;</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>
					<span style=color:#66d9ef>for</span> k <span style=color:#f92672>=</span> j<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>M
						<span style=color:#66d9ef>if</span> (m<span style=color:#f92672>&gt;&gt;</span>(k<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>))<span style=color:#f92672>&amp;</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> component[j] <span style=color:#66d9ef>in</span> G[component[k]]
							good <span style=color:#f92672>=</span> false
						<span style=color:#66d9ef>end</span>
					<span style=color:#66d9ef>end</span>
				<span style=color:#66d9ef>end</span>
			<span style=color:#66d9ef>end</span>
			<span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span>good
				<span style=color:#66d9ef>continue</span>
			<span style=color:#66d9ef>end</span>

			cnt <span style=color:#f92672>=</span> length([j <span style=color:#66d9ef>for</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>M <span style=color:#66d9ef>if</span> (m<span style=color:#f92672>&gt;&gt;</span>(j<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>))<span style=color:#f92672>&amp;</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>])
			size <span style=color:#f92672>=</span> sum([pkginfo[component[j]]<span style=color:#f92672>.</span>size <span style=color:#66d9ef>for</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>M <span style=color:#66d9ef>if</span> (m<span style=color:#f92672>&gt;&gt;</span>(j<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>))<span style=color:#f92672>&amp;</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>])
			best <span style=color:#f92672>=</span> max((cnt, size, m), best)
		<span style=color:#66d9ef>end</span>

		<span style=color:#66d9ef>for</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>M
			<span style=color:#66d9ef>if</span> (best[<span style=color:#ae81ff>3</span>]<span style=color:#f92672>&gt;&gt;</span>(j<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>))<span style=color:#f92672>&amp;</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span>
				delete!(ans, component[j])
			<span style=color:#66d9ef>end</span>
		<span style=color:#66d9ef>end</span>
	<span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>Let&rsquo;s save it to a file:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jl data-lang=jl>open(<span style=color:#e6db74>&#34;out&#34;</span>, <span style=color:#e6db74>&#34;w&#34;</span>) <span style=color:#66d9ef>do</span> f
	<span style=color:#66d9ef>for</span> i <span style=color:#66d9ef>in</span> ans
		println(f, pkgname[i])
	<span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>Alright, time to install everything! It&rsquo;ll take about 30 minutes for everything to download, depending on your internet connection. Make sure you have the <code>multilib</code> repository enabled.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo pacman -Sdd <span style=color:#66d9ef>$(</span>cat out<span style=color:#66d9ef>)</span>
</code></pre></div><p>After everything finishes downloading, we get a bunch more errors?</p>
<pre tabindex=0><code>error: failed to commit transaction (conflicting files)
Errors occurred, no packages were upgraded.
</code></pre><p>Normally this isn&rsquo;t a good idea, but since we don&rsquo;t care if we end up with a broken system, let&rsquo;s tell <code>pacman</code> to ignore all conflicting files:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo pacman -Sdd <span style=color:#66d9ef>$(</span>cat out<span style=color:#66d9ef>)</span> --overwrite <span style=color:#e6db74>&#39;*&#39;</span>
</code></pre></div><p>What? Yet another error?</p>
<pre tabindex=0><code>(12232/12232) checking for file conflicts                          [####################################] 100%
(12232/12232) checking available disk space                        [####################################] 100%
error: Partition / too full: 44153437 blocks needed, 32623558 blocks free
error: not enough free disk space
error: failed to commit transaction (not enough free disk space)
Errors occurred, no packages were upgraded.
</code></pre><p>I don&rsquo;t have enough disk space? NOOOOOOOO!!!!!</p>
<p>Oh well, I guess I&rsquo;ll delete the testing VM and try again and redownload <em>everything</em>. This is going to take a while.</p>
<p>Stay tuned.</p>
</p>
</div>
</div>
</main><footer class=footer>
<span>Made with ❤️ by Ta180m - CC BY-SA 4.0</span>
</footer>
</body>
</html>